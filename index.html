<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โหวตเลือกแบบเสื้อโรงเรียน</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <!-- Lucide Icons for modern icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>

    <style>
        /* Using Google Fonts for a softer, more modern look */
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600&display=swap');
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            background-color: #f0fdf4; /* A light green pastel background */
        }
        .main-container {
            background-image: linear-gradient(to bottom right, #fefce8, #dcfce7, #ccfbf1);
        }
        .form-input, .form-select {
            @apply w-full px-4 py-3 bg-white bg-opacity-70 border border-green-200 rounded-xl focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all duration-300 placeholder-gray-500;
        }
        .image-choice {
            @apply border-4 border-transparent rounded-2xl overflow-hidden cursor-pointer transition-all duration-300 shadow-md hover:shadow-xl hover:scale-105;
        }
        .image-choice.selected {
            @apply border-yellow-400 scale-105 ring-4 ring-yellow-200;
        }
        .submit-btn {
            @apply w-full flex items-center justify-center gap-2 bg-gradient-to-r from-yellow-400 to-amber-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300;
        }
        .progress-bar-bg {
            @apply w-full bg-gray-200 rounded-full h-6 overflow-hidden;
        }
        .progress-bar-fill {
            @apply bg-gradient-to-r from-green-400 to-teal-500 h-6 flex items-center justify-center text-xs font-medium text-white text-center p-0.5 leading-none rounded-full transition-all duration-500;
        }
        .stat-card {
            @apply bg-white bg-opacity-80 p-6 rounded-2xl shadow-md;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="image-zoom-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="relative">
            <img id="zoomed-image" src="" class="max-w-full max-h-[90vh] rounded-lg" alt="Zoomed Image">
            <button id="close-zoom" class="absolute -top-4 -right-4 bg-white text-black rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold">&times;</button>
        </div>
    </div>

    <div class="main-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-green-800 flex items-center justify-center gap-3">
                <i data-lucide="award"></i>
                โหวตเลือกแบบเสื้อกิจกรรม
            </h1>
            <p class="text-gray-600 mt-2">เลือกแบบที่นักเรียนชอบที่สุด</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Side: Voting Form -->
            <div class="bg-white/50 p-6 rounded-2xl shadow-lg backdrop-blur-sm">
                <form id="vote-form">
                    <!-- Step 1: Image Selection -->
                    <div class="mb-6">
                        <h2 class="font-semibold text-xl text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="image"></i>ขั้นตอนที่ 1: เลือกแบบเสื้อ</h2>
                        <div id="image-options" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <!-- Image options will be injected here by JS -->
                        </div>
                        <input type="hidden" name="choice" id="selected-choice" required>
                    </div>

                    <!-- Step 2: Personal Information -->
                    <div class="mb-6">
                        <h2 class="font-semibold text-xl text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="user-check"></i>ขั้นตอนที่ 2: กรอกข้อมูล</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="studentId" class="block text-sm font-medium text-gray-700 mb-1">เลขประจำตัว (5 หลัก)</label>
                                <input type="text" id="studentId" name="studentId" class="form-input" placeholder="เช่น 12345" required maxlength="5" pattern="\d{5}">
                            </div>
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label>
                                <input type="text" id="firstName" name="firstName" class="form-input" placeholder="ชื่อจริง" required>
                            </div>
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">นามสกุล</label>
                                <input type="text" id="lastName" name="lastName" class="form-input" placeholder="นามสกุล" required>
                            </div>
                            <div>
                                <label for="class" class="block text-sm font-medium text-gray-700 mb-1">ชั้น</label>
                                <select id="class" name="class" class="form-select" required>
                                    <option value="" disabled selected>-- เลือกชั้นเรียน --</option>
                                    <option value="ม.1/1">ม.1/1</option>
                                    <option value="ม.2/1">ม.2/1</option>
                                    <option value="ม.3/1">ม.3/1</option>
                                    <option value="ม.4/1">ม.4/1</option>
                                    <option value="ม.5/1">ม.5/1</option>
                                    <option value="ม.6/1">ม.6/1</option>
                                </select>
                            </div>
                             <div class="sm:col-span-2">
                                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">ไซส์เสื้อ</label>
                                <select id="size" name="size" class="form-select" required>
                                    <option value="" disabled selected>-- เลือกขนาดเสื้อ --</option>
                                    <option value="S">ไซส์ S (รอบอก 38 นิ้ว)</option>
                                    <option value="M">ไซส์ M (รอบอก 40 นิ้ว)</option>
                                    <option value="L">ไซส์ L (รอบอก 42 นิ้ว)</option>
                                    <option value="XL">ไซส์ XL (รอบอก 44 นิ้ว)</option>
                                    <option value="3L">ไซส์ 3L (รอบอก 46 นิ้ว)</option>
                                    <option value="4L">ไซส์ 4L (รอบอก 48 นิ้ว)</option>
                                    <option value="5L">ไซส์ 5L (รอบอก 50 นิ้ว)</option>
                                    <option value="6L">ไซส์ 6L (รอบอก 52 นิ้ว)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Submission -->
                    <div>
                        <h2 class="font-semibold text-xl text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="send"></i>ขั้นตอนที่ 3: ส่งผลโหวต</h2>
                        <button type="submit" class="submit-btn">
                            <i data-lucide="check-circle"></i>
                            <span>ยืนยันการโหวต</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right Side: Results -->
            <div id="results-section" class="space-y-8">
                <!-- Overall Results Chart -->
                <div class="stat-card">
                    <h2 class="font-bold text-2xl text-green-800 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3"></i>ผลโหวตโดยรวม</h2>
                    <div class="h-80"><canvas id="resultsChart"></canvas></div>
                </div>

                <!-- Voting Progress -->
                <div class="stat-card">
                    <h2 class="font-bold text-2xl text-green-800 mb-4 flex items-center gap-2"><i data-lucide="pie-chart"></i>สถานะการโหวต</h2>
                    <div id="progress-bars" class="space-y-3">
                        <!-- Progress bars will be injected here -->
                    </div>
                </div>

                <!-- Size Summary Table -->
                <div class="stat-card">
                    <h2 class="font-bold text-2xl text-green-800 mb-4 flex items-center gap-2"><i data-lucide="shirt"></i>สรุปจำนวนตามไซส์เสื้อ</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-green-700 uppercase bg-green-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 rounded-l-lg">ชั้น</th>
                                    <th scope="col" class="px-2 py-3 text-center">S</th>
                                    <th scope="col" class="px-2 py-3 text-center">M</th>
                                    <th scope="col" class="px-2 py-3 text-center">L</th>
                                    <th scope="col" class="px-2 py-3 text-center">XL</th>
                                    <th scope="col" class="px-2 py-3 text-center">3L</th>
                                    <th scope="col" class="px-2 py-3 text-center">4L</th>
                                    <th scope="col" class="px-2 py-3 text-center">5L</th>
                                    <th scope="col" class="px-2 py-3 text-center rounded-r-lg">6L</th>
                                </tr>
                            </thead>
                            <tbody id="size-summary-table">
                                <!-- Table rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Developed with ❤️ for School Activities.</p>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbysqJtNrGOo7IEFjQqkFKt-XId9tx2rd4uRp5o0EspB2vDvUP2VV2FjAkGrtCsF6wgU/exec';
        const IMAGE_SOURCES = [
            'https://img2.pic.in.th/pic/S__2596878.md.jpg',
            'https://img5.pic.in.th/file/secure-sv1/S__2596876.md.jpg',
            'https://img2.pic.in.th/pic/S__2596877.md.jpg',
            'https://img5.pic.in.th/file/secure-sv1/S__2596875.md.jpg',
            'https://img2.pic.in.th/pic/S__2596873.md.jpg'
        ];
        const CLASS_TOTALS = {
            'ม.1/1': 35, 'ม.2/1': 34, 'ม.3/1': 35,
            'ม.4/1': 35, 'ม.5/1': 35, 'ม.6/1': 35
        };
        const SIZES = ['S', 'M', 'L', 'XL', '3L', '4L', '5L', '6L'];

        // --- DOM ELEMENTS ---
        const form = document.getElementById('vote-form');
        const imageOptionsContainer = document.getElementById('image-options');
        const selectedChoiceInput = document.getElementById('selected-choice');
        let resultsChart = null;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            populateImageChoices();
            setupEventListeners();
            fetchResults(); // Fetch initial results on page load
        });

        // --- FUNCTIONS ---

        function populateImageChoices() {
            IMAGE_SOURCES.forEach((src, index) => {
                const choiceValue = index + 1;
                const choiceDiv = document.createElement('div');
                choiceDiv.className = 'image-choice';
                choiceDiv.dataset.choice = choiceValue;

                const img = document.createElement('img');
                img.src = src;
                img.alt = `แบบที่ ${choiceValue}`;
                img.className = 'w-full h-auto object-cover';
                img.onerror = () => { 
                    img.src = `https://placehold.co/400x300/fefce8/333?text=Image+${choiceValue}+Error`;
                    img.alt = `เกิดข้อผิดพลาดในการโหลดรูปภาพที่ ${choiceValue}`;
                };
                
                choiceDiv.appendChild(img);
                imageOptionsContainer.appendChild(choiceDiv);
            });
        }

        function setupEventListeners() {
            // Image selection
            imageOptionsContainer.addEventListener('click', (e) => {
                const choiceDiv = e.target.closest('.image-choice');
                if (!choiceDiv) return;

                document.querySelectorAll('.image-choice').forEach(div => div.classList.remove('selected'));
                choiceDiv.classList.add('selected');
                selectedChoiceInput.value = choiceDiv.dataset.choice;
            });

            // Form submission
            form.addEventListener('submit', handleFormSubmit);

            // Image Zoom
            const modal = document.getElementById('image-zoom-modal');
            const zoomedImage = document.getElementById('zoomed-image');
            const closeBtn = document.getElementById('close-zoom');

            imageOptionsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') {
                    zoomedImage.src = e.target.src;
                    modal.classList.remove('hidden');
                }
            });

            closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // --- Validation ---
            if (!data.choice) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกแบบเสื้อก่อน', 'error');
                return;
            }
            if (!/^\d{5}$/.test(data.studentId)) {
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกเลขประจำตัว 5 หลักให้ถูกต้อง', 'error');
                return;
            }
            if (!data.firstName || !data.lastName || !data.class || !data.size) {
                 Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบทุกช่อง', 'error');
                return;
            }

            // --- Submission ---
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Using JSONP
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(response) {
                handleServerResponse(response);
                delete window[callbackName]; // Clean up
                document.body.removeChild(script);
            };

            const script = document.createElement('script');
            const params = new URLSearchParams({
                ...data,
                callback: callbackName,
                action: 'save'
            });
            script.src = `${GAS_URL}?${params.toString()}`;
            document.body.appendChild(script);
        }

        function handleServerResponse(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ!',
                    text: 'ขอบคุณสำหรับการโหวต',
                }).then(() => {
                    form.reset();
                    document.querySelectorAll('.image-choice').forEach(div => div.classList.remove('selected'));
                    fetchResults();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: response.message || 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                });
            }
        }
        
        function fetchResults() {
             const callbackName = 'jsonp_results_callback_' + Math.round(100000 * Math.random());
             window[callbackName] = function(response) {
                if (response.success) {
                    displayResults(response.data);
                } else {
                    console.error("Failed to fetch results:", response.message);
                     Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดผลโหวตได้', 'error');
                }
                delete window[callbackName];
                document.body.removeChild(script);
            };

            const script = document.createElement('script');
            script.src = `${GAS_URL}?action=read&callback=${callbackName}`;
            document.body.appendChild(script);
        }

        function displayResults(data) {
            updateChart(data.voteCounts);
            updateProgressBars(data.classCounts);
            updateSizeTable(data.sizeCounts);
        }

        function updateChart(voteCounts) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            const chartData = {
                labels: IMAGE_SOURCES.map((_, i) => `แบบที่ ${i + 1}`),
                datasets: [{
                    label: 'จำนวนโหวต',
                    data: voteCounts,
                    backgroundColor: [
                        'rgba(251, 191, 36, 0.6)',
                        'rgba(163, 230, 53, 0.6)',
                        'rgba(52, 211, 153, 0.6)',
                        'rgba(251, 146, 60, 0.6)',
                        'rgba(34, 197, 94, 0.6)'
                    ],
                    borderColor: [
                        'rgba(251, 191, 36, 1)',
                        'rgba(163, 230, 53, 1)',
                        'rgba(52, 211, 153, 1)',
                        'rgba(251, 146, 60, 1)',
                        'rgba(34, 197, 94, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 12, // Rounded bars
                }]
            };

            if (resultsChart) {
                resultsChart.data = chartData;
                resultsChart.update();
            } else {
                resultsChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            },
                             x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.7)',
                                titleFont: { size: 14 },
                                bodyFont: { size: 12 },
                                padding: 10,
                                cornerRadius: 8,
                            }
                        }
                    }
                });
            }
        }
        
        function updateProgressBars(classCounts) {
            const container = document.getElementById('progress-bars');
            container.innerHTML = ''; // Clear previous bars

            for (const className in CLASS_TOTALS) {
                const total = CLASS_TOTALS[className];
                const voted = classCounts[className] || 0;
                const percentage = total > 0 ? ((voted / total) * 100).toFixed(1) : 0;
                
                const barHtml = `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-gray-700">${className}</span>
                            <span class="text-sm font-medium text-gray-600">${voted} / ${total} คน</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += barHtml;
            }
        }

        function updateSizeTable(sizeCounts) {
            const tableBody = document.getElementById('size-summary-table');
            tableBody.innerHTML = ''; // Clear previous data

            for (const className in CLASS_TOTALS) {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-green-50';
                
                let rowHtml = `<th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${className}</th>`;
                SIZES.forEach(size => {
                    const count = sizeCounts[className]?.[size] || 0;
                    rowHtml += `<td class="px-2 py-4 text-center">${count}</td>`;
                });

                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            }
        }

    </script>
</body>
</html>
